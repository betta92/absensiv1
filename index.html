<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Guru Geolocation</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; text-align: center; padding: 20px; background-color: #eef2f3; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: inline-block; max-width: 450px; width: 100%; }
        #status { margin: 15px 0; padding: 12px; border-radius: 8px; font-weight: bold; font-size: 14px; }
        .waiting { background: #fff3cd; color: #856404; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        select, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 6px; font-size: 16px; }
        select { border: 1px solid #ddd; }
        button { border: none; background: #2c3e50; color: white; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìç Absensi Guru</h2>
    <p>Sistem Validasi Lokasi Otomatis</p>
    <hr>

    <select id="namaGuru">
        <option value="">-- Memuat Daftar Guru... --</option>
    </select>

    <div id="status" class="waiting">Mendeteksi lokasi & data...</div>

    <button id="btnAbsen" disabled>Kirim Absen</button>
</div>

<script>
    // --- KONFIGURASI ---
    const schoolLat = -7.541549; // GANTI KOORDINAT SEKOLAH
    const schoolLng = 108.696524; 
    const maxRadius = 30; 
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzYoXi_sjPkzhdFiax27vSUJDV4OgfOPkiqvHgrIqJN9scEY1K-HpLDMKhPUVIWPl75qw/exec'; 

    const selectNama = document.getElementById('namaGuru');
    const statusDisplay = document.getElementById('status');
    const btnAbsen = document.getElementById('btnAbsen');
    let userDistance = null;

    // 1. AMBIL DAFTAR NAMA DARI SHEETS SAAT HALAMAN DIBUKA
    window.onload = () => {
        fetch(scriptURL)
            .then(res => res.json())
            .then(names => {
                selectNama.innerHTML = '<option value="">-- Pilih Nama Anda --</option>';
                names.forEach(nama => {
                    let opt = document.createElement('option');
                    opt.value = nama;
                    opt.text = nama;
                    selectNama.appendChild(opt);
                });
            })
            .catch(err => {
                statusDisplay.innerHTML = "Gagal memuat daftar nama!";
                statusDisplay.className = "error";
            });
    };

    // 2. HITUNG JARAK (HAVERSINE)
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    // 3. PANTAU LOKASI GURU
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
            userDistance = getDistance(pos.coords.latitude, pos.coords.longitude, schoolLat, schoolLng);
            
            if (userDistance <= maxRadius) {
                statusDisplay.innerHTML = `‚úÖ Anda berada di area sekolah (Jarak: ${Math.round(userDistance)}m)`;
                statusDisplay.className = "success";
                btnAbsen.disabled = false;
            } else {
                statusDisplay.innerHTML = `‚ùå Di luar area sekolah (Jarak: ${Math.round(userDistance)}m)`;
                statusDisplay.className = "error";
                btnAbsen.disabled = true;
            }
        }, err => {
            statusDisplay.innerHTML = "‚ö†Ô∏è Aktifkan GPS dan berikan izin lokasi!";
            statusDisplay.className = "error";
        }, { enableHighAccuracy: true });
    }

    // 4. KIRIM DATA KE GOOGLE SHEETS
    btnAbsen.onclick = () => {
        const nama = selectNama.value;
        if (!nama) return alert("Pilih nama Anda!");

        btnAbsen.disabled = true;
        btnAbsen.innerText = "Mengirim...";

        fetch(scriptURL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ nama: nama, jarak: Math.round(userDistance) })
        }).then(() => {
            alert("Absensi Berhasil Disimpan!");
            btnAbsen.innerText = "Selesai";
        }).catch(() => {
            alert("Gagal mengirim data!");
            btnAbsen.disabled = false;
            btnAbsen.innerText = "Kirim Absen";
        });
    };
</script>

</body>
</html>

